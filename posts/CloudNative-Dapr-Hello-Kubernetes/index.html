<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Dapr Hello Kubernetes" /><meta property="og:locale" content="en_US" /><meta name="description" content="created : 2021-11-07, updated : 2021-11-07" /><meta property="og:description" content="created : 2021-11-07, updated : 2021-11-07" /><link rel="canonical" href="https://ahnchan.github.io/posts/CloudNative-Dapr-Hello-Kubernetes/" /><meta property="og:url" content="https://ahnchan.github.io/posts/CloudNative-Dapr-Hello-Kubernetes/" /><meta property="og:site_name" content="Ahnchan" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-07T16:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Dapr Hello Kubernetes" /><meta name="twitter:site" content="@claude_ahn" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-11-09T13:46:04+09:00","datePublished":"2021-11-07T16:00:00+09:00","description":"created : 2021-11-07, updated : 2021-11-07","headline":"Dapr Hello Kubernetes","mainEntityOfPage":{"@type":"WebPage","@id":"https://ahnchan.github.io/posts/CloudNative-Dapr-Hello-Kubernetes/"},"url":"https://ahnchan.github.io/posts/CloudNative-Dapr-Hello-Kubernetes/"}</script><title>Dapr Hello Kubernetes | Ahnchan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ahnchan"><meta name="application-name" content="Ahnchan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JLF9MP8SLS"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JLF9MP8SLS'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">Ahnchan</a></div><div class="site-subtitle font-italic">The Infinity To Beyond!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ahnchan" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/claude_ahn" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahnchan','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Dapr Hello Kubernetes</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Dapr Hello Kubernetes</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Chanyoung Ahn </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Nov 7, 2021, 4:00 PM +0900" prep="on" > Nov 7, 2021 <i class="unloaded">2021-11-07T16:00:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Nov 9, 2021, 1:46 PM +0900" prefix="Updated " > Nov 9, 2021 <i class="unloaded">2021-11-09T13:46:04+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1811 words">10 min</span></div></div><div class="post-content"><p>created : 2021-11-07, updated : 2021-11-07</p><h1 id="introduction">Introduction</h1><p>이번 튜토리얼에서는 Dapr를 Kubernetes에 올려보겠다. dapr의 특징인 Service Invocation과 State Management 를 사용할 것이다.</p><blockquote><p>Note. 본 소스는 Dapr 공식 Quick Start의 <a href="https://github.com/dapr/quickstarts/tree/v1.4.0/hello-kubernetes">Hello-Kubernetes</a>를 바탕으로 Dapr의 기능을 설명하기 위해 Application을 추가하여 작성하였다. 모두 Node.js 로 작성을 하였다.</p></blockquote><h1 id="requirements">Requirements</h1><p>이전 Dapr 튜토리얼을 한번 보는 것은 좋겠다. 필수 사항은 아니고 본 튜토리얼을 따라가다 보면 자연스럽게 익힐 수 있을 것으로 생각된다.</p><p>Dapr Installation: <a href="https://ahnchan.github.io/posts/CloudNative-Dapr-installation/">https://ahnchan.github.io/posts/CloudNative-Dapr-installation/</a></p><p>Dapr Quick Start - Hello World: <a href="https://ahnchan.github.io/posts/CloudNative-Dapr-QuickStart-HelloWorl/">https://ahnchan.github.io/posts/CloudNative-Dapr-QuickStart-HelloWorl/</a></p><blockquote><p>Note. Kubernetes 의 설치는 Docker Desktop 에서 설정에서 Kubernetes를 Enable 시키면 된다.</p></blockquote><blockquote><p>Note. 외부 Kubernetes를 구성하고 싶으면 “<a href="https://ahnchan.github.io/posts/Platform-kubernetes_ubuntu20/">Ansible을 이용하여 Ubuntu 20.04에 Kubernetes 구성하기</a>”에서 간단하게 구성하는 설명을 해놓았다.</p></blockquote><h1 id="pre-installation">Pre-Installation</h1><p>Dapr Installation: <a href="https://ahnchan.github.io/posts/CloudNative-Dapr-Installation/">https://ahnchan.github.io/posts/CloudNative-Dapr-Installation/</a> Dapr Installation(Darp.io): <a href="https://docs.dapr.io/getting-started/">https://docs.dapr.io/getting-started/</a> Docker: <a href="https://www.docker.com/products/docker-desktop">https://www.docker.com/products/docker-desktop</a> Node.js: <a href="https://nodejs.org/en/download/">https://nodejs.org/en/download/</a> Heml : <a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a> Redis : state store로 Redis를 사용한다. 그래서 Kubernetes 환경에서 Redis 설치가 필요하다. <a href="https://docs.dapr.io/getting-started/configure-state-pubsub/">https://docs.dapr.io/getting-started/configure-state-pubsub/</a></p><blockquote><p>Note. 이전 튜토리얼은 Self-Hosted이였다. Kubernetes 환경에서 깔끔하게 구동하려면 dapr uninstall –all 로 제거하고 진행하는 것도 좋을 것으로 생각된다.</p></blockquote><h1 id="구성">구성</h1><p>Gateway에서 node1, node2 로 Routing을 한다. 각각의 node는 /status 라는 상태를 체크하는 API를 제공하여 Node별로 잘 동작하는지 확인 할 수 있다.</p><p>/{NODE_NAME}/status: NODE_NAME은 gateway, nodoeapp1, nodeapp2이다. 각각에 status를 확인한다. 단순히 ok를 Return 하는 구조이다. /neworder: nodeapp2로 호출되며, 해당 정보를 nodeapp1로 전달하여 State Store에 order id를 저장한다. /order: nodeapp1을 호출하며, State Store에 저장된 Order Id를 조회 한다.</p><p>아래 Diagram은 /neworder를 호출할때의 흐름을 번호로 표시한 것이다. 소스를 확인해보면 gateway, nodeapp1, nodeapp2는 모두 자신(localhost)의 3500(Dapr Port)를 호출한다. 그러면 App Name을으로 해당 서비스(Application)를 호출을 한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/posts/assets/cloudnative-dapr/images/dapr-hello-kubernetes-diagram.png" alt="Diagram" width="500" /></p><blockquote><p>Note. 해당 소스는 <a href="https://github.com/ahnchan/tutorial-dapr-hello-kubernetes">https://github.com/ahnchan/tutorial-dapr-hello-kubernetes</a>에 있으며, 소스에 대해 중요한 부분만 중간에 설명을 하겠다.</p></blockquote><h1 id="redis-설치기">Redis 설치기</h1><p>Redis는 State Store로 사용하며 Order의 Id를 저장한다. Helm을 이용하여 Kubernetes에 설치한다. <a href="https://docs.dapr.io/getting-started/configure-state-pubsub/">설치 문서 정보</a></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>$ helm repo add bitnami https://charts.bitnami.com/bitnami
$ helm repo update
$ helm install redis bitnami/redis
NAME: redis
LAST DEPLOYED: Mon Nov  8 13:12:24 2021
NAMESPACE: default
STATUS: deployed
...
</pre></table></code></div></div><h1 id="deployment">Deployment</h1><p>먼저 Local에 docker 이미지 생성한다. 각각의 디렉토리 (/nodegateway, /node1, /node2)에서 실행을 한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ cd nodegateway
$ npm run docker-build
</pre></table></code></div></div><blockquote><p>Note. Docker 이미지는 docker images 로 확인할 수 있다.</p></blockquote><p>Docker 이미지가 잘 만들어졌으면, 이제 Kubernetes에 Deploy를 해보자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ cd ../deploy
$ kubectl apply -f .
</pre></table></code></div></div><p>모두 정상적으로 되었으면 아래와 같이 확인 할 수 있다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>$ kubectl get services
NAME               TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                               AGE
kubernetes         ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP                               10d
nodeapp1-dapr      ClusterIP      None             &lt;none&gt;        80/TCP,50001/TCP,50002/TCP,9090/TCP   39m
nodeapp2-dapr      ClusterIP      None             &lt;none&gt;        80/TCP,50001/TCP,50002/TCP,9090/TCP   6m23s
nodegateway        LoadBalancer   10.105.151.114   localhost     80:31292/TCP                          40m
nodegateway-dapr   ClusterIP      None             &lt;none&gt;        80/TCP,50001/TCP,50002/TCP,9090/TCP   40m
redis-headless     ClusterIP      None             &lt;none&gt;        6379/TCP                              89m
redis-master       ClusterIP      10.96.111.168    &lt;none&gt;        6379/TCP                              89m
redis-replicas     ClusterIP      10.103.174.207   &lt;none&gt;        6379/TCP                              89m
zipkin             ClusterIP      10.110.155.108   &lt;none&gt;        9411/TCP                              80m
</pre></table></code></div></div><h1 id="테스트하기">테스트하기</h1><p>각 Application의 status 를 확인해보자. 해당 Application 이 Deploy가 잘 되었는지 알수 있다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>$ curl http://localhost/order/status
{
	“status”: “ok”
}

$ curl http://localhost/neworder/status
{
	“status”: “ok”
}

$ curl http://localhost/gateway/status
{
	“status”: “ok”
}

</pre></table></code></div></div><p>이번에는 State Store에 order 정보를 저장해보자. neworder로 Order를 저장을 요청 한다. sample.json을</p><p>파일: sample.json</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>{"data":{"orderId":"42"}}

</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ curl --request POST --data @sample.json --header Content-Type:application/json http://localhost/neworder
</pre></table></code></div></div><p>이제 저장된 Order를 확인해 보자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>$ curl http://localhost/order
{
  "orderId": "42"
}
</pre></table></code></div></div><h1 id="소스-확인해보기">소스 확인해보기</h1><p>동작되는 것을 확인해보았으니 Source를 한번 보자.</p><h2 id="gateway에서-nodeapp2로-routing하기">Gateway에서 nodeapp2로 Routing하기</h2><p>gateway는 외부에서 들어오는 API 요청을 해당 Application 으로 Routing해주는 일을 한다.</p><p>위치: /nodegateway 파일: app.js</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>const daprUrl = `http://localhost:${daprPort}/v1.0/invoke`;
 
const orderUrl = daprUrl + "/nodeapp1/method";
const neworderUrl = daprUrl + "/nodeapp2/method";
 
// Node1 /order
app.get('/order', async (req, res) =&gt; {
   const url = `${orderUrl}/order`;
   req.pipe(request(url)).pipe(res);
});
 
// Node2 /neworder
app.post('/neworder', async (req, res) =&gt; {
   const url = `${neworderUrl}/neworder`;
 req.pipe(request(url)).pipe(res);
});
</pre></table></code></div></div><p>/order (nodeapp1), /neworder(nodeapp2) 모두 localhost:${daprPort} 를 호출한다. nodeapp1, nodeapp2의 실제 서버가 어디에 있던지 Path를 v1.0/invoke/nodeapp1 으로 해당 Application을 명시할 수 있다.</p><h2 id="nodeapp2에서-nodeapp1-호출하기">Nodeapp2에서 nodeapp1 호출하기</h2><p>/neworder이 gateway를 통해서 nodeapp2 로 전달이 된다. 그러면 nodeapp1으로 다시 호출을 한다.</p><blockquote><p>Note. Dapr를 설명하기 위해 임의로 구현한 작성한 코드이다. 실제 환경이면 직접 nodeapp1을 호출하는게 맞을 것이다.</p></blockquote><p>위치: /node2 파일: app.js</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>const stateUrl = `http://localhost:${daprPort}/v1.0/invoke/nodeapp1/method/neworder`;
 
...
 
app.post('/neworder', (req, res) =&gt; {
   const data = req.body;
   const orderId = data.orderId;
   console.log("Got a new order! Order ID: " + orderId);
   console.log("url: "+ stateUrl);
   console.log("state: "+ JSON.stringify(data));
 
   fetch(stateUrl, {
       method: "POST",
       body: JSON.stringify(data),
       headers: {
           "Content-Type": "application/json"
       }
</pre></table></code></div></div><p>/neworder 로 호출된 정보는 stateUrl이라는 nodeapp1에 정의된 /neworder를 호출하게 되어 있다. stateUrl에서 보듯이 nodeapp2에서도 localhost의 Dapr Port를 호출하게 되어 있다.</p><h2 id="nodeapp1에서-state-저장">Nodeapp1에서 State 저장</h2><p>nodeapp1에서는 State Store에 정보를 저장한다.</p><p>위치: /node1 파일: app.js</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>const stateUrl = `http://localhost:${daprPort}/v1.0/state/${stateStoreName}`;
 
…
 
app.post('/neworder', (req, res) =&gt; {
   const data = req.body.data;
   const orderId = data.orderId;
   console.log("Got a new order! Order ID: " + orderId);
 
   const state = [{
       key: "order",
       value: data
   }];
 
   fetch(stateUrl, {
       method: "POST",
       body: JSON.stringify(state),
       headers: {
           "Content-Type": "application/json"
       }
</pre></table></code></div></div><p>/neworder는 State Store에 Order ID를 저장한다. State Store도 Dapr의 API를 호출하여 Key, Value 형태로 저장을 한다. stateUrl이 localhost의 Dapr 포트를 호출하고 /v1.0/state 로 State Store를 명시하고 있다.</p><p>저장된 order 정보는 /order로 확인을 한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>const stateUrl = `http://localhost:${daprPort}/v1.0/state/${stateStoreName}`;
 
...
 
app.get('/order', (_req, res) =&gt; {
   console.log('/order');
   fetch(`${stateUrl}/order`)
       .then((response) =&gt; {
           if (!response.ok) {
               throw "Could not get state.";
           }
 
           return response.text();
       }).then((orders) =&gt; {
           res.send(orders);
       }).catch((error) =&gt; {
           console.log(error);
           res.status(500).send({message: error});
       });
});
 
</pre></table></code></div></div><h1 id="등록된-application-service-정리하기">등록된 Application, Service 정리하기</h1><p>튜토리얼을 종료하고 정리를 해보자. 새로 생성한 pods, service를 삭제를 한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ cd deploy
$ kubectl delete -f .
</pre></table></code></div></div><p>Redis 서비스도 삭제 한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ helm uninstall redis
</pre></table></code></div></div><h1 id="conclusions">Conclusions</h1><p>Dapr의 가장 기본적인 기능을 확인해봤다. 서비스의 위치를 알지 못해도, Application 이름으로만 API를 호출할 수가 있다. 또한 State Store를 기본 제공하고 있어서 어느 앱에서나 State Store를 Dapr의 API만을 이용하여 접근이 가능해 진다. Dapr는 API를 호출하는 방식이기 때문에 어떤 언어든 상관없이 사용이 가능하다. 특별한 SDK, Library없이 Dapr를 이용하면 여러가지 언어로 Micro Service를 구현할 수 있는 장점이 있다.</p><h1 id="references">References</h1><p><a href="https://github.com/dapr/quickstarts/tree/v1.4.0/hello-kubernetes">Dapr Quick Start - Hello Kubernetes</a></p><p><a href="https://github.com/dapr/quickstarts/tree/v1.4.0/distributed-calculator">Dapr Quick Start - distributerd caculator</a></p><p><a href="https://docs.dapr.io/getting-started/configure-state-pubsub/">Redis Installation (State, Pub/Sub)</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cloudnative/'>CloudNative</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Dapr Hello Kubernetes - Ahnchan&url=https://ahnchan.github.io/posts/CloudNative-Dapr-Hello-Kubernetes/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Dapr Hello Kubernetes - Ahnchan&u=https://ahnchan.github.io/posts/CloudNative-Dapr-Hello-Kubernetes/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Dapr Hello Kubernetes - Ahnchan&url=https://ahnchan.github.io/posts/CloudNative-Dapr-Hello-Kubernetes/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Platform-kafka-quick-start/">Apache Kafka - Quick Start</a><li><a href="/posts/Install-Jupyterhub_on_Microk8s/">Install JupyterHub on Microk8s</a><li><a href="/posts/Install-Airflow_on_Microk8s/">Install Apache Airflow on Microk8s</a><li><a href="/posts/gRPC-basic-java-step1/">gRPC - Java 환경구성하기, Dummy Service 만들기</a><li><a href="/posts/gRPC-basic-java-step2/">gRPC - Greeting Service 만들기</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav><div style="margin-top:20px;"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2304979176656635" data-ad-slot="4120180236" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-2304979176656635" data-ad-slot="1066641487"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/CloudNative-Service-Registration-and-Discovery/"><div class="card-body"> <span class="timeago small" > Sep 9, 2021 <i class="unloaded">2021-09-09T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Service Registration and Discovery (Spring Boot)</h3><div class="text-muted small"><p> created : 2021-09-09, updated : 2021-09-09 Introduction Spring Framework 환경에서 서비스를 등록/관리하고 이 서비스를 다른 서비스에서 사용하는 방법을 설명해보겠다. 이 문서는 https://spring.io/guides/gs/service-registration-and-discovery/를 기...</p></div></div></a></div><div class="card"> <a href="/posts/CloudNative-Client-Side-Load-Balancer-Ribbon/"><div class="card-body"> <span class="timeago small" > Sep 17, 2021 <i class="unloaded">2021-09-17T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Client Side Load Balancer - Ribbon (Spring Cloud)</h3><div class="text-muted small"><p> created : 2021-09-17, updated : 2021-09-17 Introduction 이전 튜토리얼에서 Service를 등록하고 간단하게 호출하는 부분을 진행했다. 이제는 Microservice 환경에서 각각의 서비스간 호출을 위해 사용하는 Load Balancing을 알아보겠다. Requirements Service Registr...</p></div></div></a></div><div class="card"> <a href="/posts/CloudNative-Circuit-Breaker/"><div class="card-body"> <span class="timeago small" > Oct 7, 2021 <i class="unloaded">2021-10-07T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Cloud Circuit Breaker</h3><div class="text-muted small"><p> created : 2021-10-07, updated : 2021-10-07 Introduction 서비스간 데이터를 요청할때 한쪽 서비스에 문제가 발생하였을 경우가 있다. 이럴 때를 대비하여 정보는 Default로 전달하여 전체 서비스가 오류가 나는 것을 방지 할 수 있다. 이때를 위해 Circuit Breaker를 이용하여 Default정보를 보...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CloudNative-Dapr-QuickStart-HelloWorl/" class="btn btn-outline-primary" prompt="Older"><p>Dapr Quick Start - Hello World</p></a> <a href="/posts/gRPC-basic-java-step1/" class="btn btn-outline-primary" prompt="Newer"><p>gRPC - Java 환경구성하기, Dummy Service 만들기</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/claude_ahn">Chanyoung Ahn</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ahnchan.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
