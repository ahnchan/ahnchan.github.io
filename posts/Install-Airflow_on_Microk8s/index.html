<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Install Apache Airflow on Microk8s" /><meta property="og:locale" content="en_US" /><meta name="description" content="created : 2023-12-01, updated : 2023-12-01" /><meta property="og:description" content="created : 2023-12-01, updated : 2023-12-01" /><link rel="canonical" href="https://ahnchan.github.io/posts/Install-Airflow_on_Microk8s/" /><meta property="og:url" content="https://ahnchan.github.io/posts/Install-Airflow_on_Microk8s/" /><meta property="og:site_name" content="Ahnchan" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-12-01T16:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Install Apache Airflow on Microk8s" /><meta name="twitter:site" content="@claude_ahn" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-12-04T16:06:48+09:00","datePublished":"2023-12-01T16:00:00+09:00","description":"created : 2023-12-01, updated : 2023-12-01","headline":"Install Apache Airflow on Microk8s","mainEntityOfPage":{"@type":"WebPage","@id":"https://ahnchan.github.io/posts/Install-Airflow_on_Microk8s/"},"url":"https://ahnchan.github.io/posts/Install-Airflow_on_Microk8s/"}</script><title>Install Apache Airflow on Microk8s | Ahnchan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ahnchan"><meta name="application-name" content="Ahnchan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JLF9MP8SLS"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JLF9MP8SLS'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">Ahnchan</a></div><div class="site-subtitle font-italic">The Infinity To Beyond!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ahnchan" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/claude_ahn" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahnchan','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Install Apache Airflow on Microk8s</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Install Apache Airflow on Microk8s</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Chanyoung Ahn </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Dec 1, 2023, 4:00 PM +0900" prep="on" > Dec 1, 2023 <i class="unloaded">2023-12-01T16:00:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Dec 4, 2023, 4:06 PM +0900" prefix="Updated " > Dec 4, 2023 <i class="unloaded">2023-12-04T16:06:48+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3165 words">17 min</span></div></div><div class="post-content"><p>created : 2023-12-01, updated : 2023-12-01</p><h1 id="introduction">Introduction</h1><p>데이터를 주기적으로 수집하고 원하는 위치에 전달하기 위한 Workflow가 필요하다. 단순히 데이터를 수집하는 것이 아니라 수집한 데이터를 가공하고 크리닝하고 필요한 형태로 변환을 해야 한다. 스케줄에 의해서 주기적으로 수집을 해야 할 수도 있지만, 외부 요청에 의해 진행이 되어야 할 수도 있다. 이런 다양한 방법의 지원이 필요하다.</p><h1 id="airflow는">Airflow는?</h1><p>Python 기반의 Workflow를 관리하는 Open Source이다. Data Scientist들이 Data를 수집하여 각종 전 처리 및 저장을 해야 할 때 필요하다. Airflow는 설치와 설정이 복잡하기는 하지만Data Scientist가 친숙한 Python 기반 이기 때문에 많이 사용되고 있다. 직접 개발을 해야 하는 번거로움이 있기는 하지만, 직접 개발을 하는 것이라 더 유연하게 처리할 수 있기도 하다. 이번에는 ETL과 같이 데이터를 수집하고 변환하고 저장하기 위한 Workflow를 수행하기 위해 Airflow를 사용해보았다. Extract하고 Transform에 초점을 맞춰서 주기적으로 Data를 특정 위치에 쌓는 것을 목표로 하였다.</p><h1 id="airflow-설치">Airflow 설치</h1><p>서버에 직접 설치도 가능하다. 하지만, 해당 서버를 Airflow와 다른 소프트웨어도 같이 설치하여 사용해야 하기 때문에 관리를 편하게 하기 위해 Kubernetes(이하 k8s) 환경에 설치하도록 하겠다.</p><h2 id="helm-repository-추가">Helm Repository 추가</h2><p>K8s에 설치하기 위해서 Helm Chart를 이용하다. 이를 위해서 Apache Airflow의 Repository를 추가한다.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>helm repo add apache-airflow https://airflow.apache.org
helm repo update
</pre></table></code></div></div><h2 id="airflow-설치하기">Airflow 설치하기</h2><p>설치를 진행한다. namespace를 airflow로 따로 지정한다. 없을 경우 생성하는 옵션을 넣어서 설치를 진행한다.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>helm upgrade <span class="nt">--install</span> airflow apache-airflow/airflow <span class="nt">--namespace</span> airflow <span class="nt">--create-namespace</span>
</pre></table></code></div></div><p>설치가 완료되면 아래와 같이 메세지가 나오면서 설치된다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre>WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /home/healthon/.kube/config
WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /home/healthon/.kube/config
Release "airflow" has been upgraded. Happy Helming!
NAME: airflow
LAST DEPLOYED: Wed Nov  8 13:25:34 2023
NAMESPACE: airflow
STATUS: deployed
REVISION: 2
TEST SUITE: None
NOTES:
Thank you for installing Apache Airflow 2.7.1!

Your release is named airflow.
You can now access your dashboard(s) by executing the following command(s) and visiting the corresponding port at localhost in your browser:

Airflow Webserver:     kubectl port-forward svc/airflow-webserver 8080:8080 --namespace airflow
Default Webserver (Airflow UI) Login credentials:
    username: admin
    password: admin
Default Postgres connection credentials:
    username: postgres
    password: postgres
    port: 5432

You can get Fernet Key value by running the following:

    echo Fernet Key: $(kubectl get secret --namespace airflow airflow-fernet-key -o jsonpath="{.data.fernet-key}" | base64 --decode)     

###########################################################
#  WARNING: You should set a static webserver secret key  #
###########################################################

You are using a dynamically generated webserver secret key, which can lead to
unnecessary restarts of your Airflow components.

Information on how to set a static webserver secret key can be found here:
https://airflow.apache.org/docs/helm-chart/stable/production-guide.html#webserver-secret-key
</pre></table></code></div></div><p>오류 문구가 없이 위와 같이 표시되면 설치가 잘된 것이다. 다음에는 Webserver와 접속을 해보겠다.</p><h2 id="airflow-브라우저에서-연결하기">Airflow 브라우저에서 연결하기</h2><p>먼저 Port-forward로 브라우저와 연결을 해보자. 이 테스트가 완료되면 언제나 연결할 수 있게 NodePort를 구성하여 연결할 것이다. 이전 설치 완료 문구를 보면 ID와 Password가 나오는 이를 참조하여 접속하면 된다. 설정을 변경하여 Helm upgrade를 수행해도 매번 위와 같은 메시지가 나온다.</p><p>Local의 8080포트를 airflow의 webserver로 접속을 하고 외부접근 IP는 모든 IP를 허용하는 명령어이다. 아래를 실행하면 터미널에서 계속 해당 작업이 돌아가도록 된다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>microk8s kubectl port-forward svc/airflow-werbserver 8080:8080 --namespace airflow --address 0.0.0.0
</pre></table></code></div></div><blockquote><p>운영 환경에서는 이방식을 사용하면 매번 upgrade등이 수행되면 해당 Bash를 실행해야 할 것이니 테스트에서만 사용하자</p></blockquote><p>해당 서버의 IP와 Port를 8080으로 브라우저에서 접속을 해본다. 아래 화면은 다음 장에서 이야기할 Dag를 Github 와 연결을 한 상태이고 아마 Dag가 비어있는 상태로 보일 것이다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/posts/assets/platform/airflow_microk8s/airflow_gui.png" alt="Airflow 첫 화면" width="500" /></p><h2 id="airflow-설정-추가하기">Airflow 설정 추가하기</h2><p>Install의 마지막 문구를 보면 Webserver secret을 설정하라고 나온다. 이를 위한 URL도 표시되어 있다. 안내에 나온 (Production Guide의 Webserver secret)[https://airflow.apache.org/docs/helm-chart/stable/production-guide.html#webserver-secret-key]를 확인하면 아래와 같다.</p><p>먼저 Key를 생성한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python3 -c 'import secrets; print(secrets.token_hex(16))'
</pre></table></code></div></div><p>위에서 나온 Key를 아래의 같에 넣으면된다. 이를 위해 value.yaml 이라는 파일을 하나 만들겠다. 위에서 만들어진 key를 <secret_key>로 대체하여 저장한다.</secret_key></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>webserverSecretKey: &lt;secret_key&gt;
</pre></table></code></div></div><blockquote><p>value.yaml 은 계속 추가되어야한다. 만약에 작업할때 이전의 내용을 넣지 않으면 기존의 default(보통 null)로 대체되기 때문에 매번 해당 정보는 유지되어야 한다.</p></blockquote><p>업그레이드를 위해서는 아래와 같이 명령을 입력한다. 물론 value.yaml 파일이 있는 위치에서 실행해야 한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>microk8s helm upgrade airflow apache-airflow/airflow --namespace airflow -f values.yaml

</pre></table></code></div></div><p>문제가 없이 실행되면 다시 Install이 끝났을 때의 안내문구와 같이 나온다. Webserver Secret을 설정하였으니 마지막 문구는 빠지고 나올 것이다.</p><h1 id="dag-소스를-연동하기">Dag 소스를 연동하기</h1><p>Dag를 연결하기 위해서는 여러가지 방법이 있다. Airflow의 home에서 dag 디렉토리를 persistence로 연결할 수도 있고, git-sync를 이용하여 Git repository를 연결할 수도 있다. 보통 Git에서 관리하는 것이 편해서 이번에는 git으로 연결해보겠다. Git의 정보가 변경되면 바로 반영이 되어 편리하다.</p><blockquote><p>Dag에 대한 개발 방법은 따로 이야기하도록 하겠다. 본 튜토리얼에는 Aiflow의 설정에 초점을 맞추었다.</p></blockquote><h2 id="public-git-설정-https방식">Public git 설정 (https방식)</h2><p>git에 Dags 파일/스트립트가 있다는 가정하게 진행을 하겠다. 아래와 같이 설정을 value.yaml에 추가한다. git-sync를 enable 시키고 git의 repo 위치를 넣어준다. branch, subPath를 입력한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>...
dags:
  gitSync:
    enabled: true
    branch: &lt;branch-name&gt;
    repo: https://github.com/&lt;username&gt;/&lt;public-repo-name&gt;.git
    subPath: &lt;dag-path&gt;

</pre></table></code></div></div><p>value.yaml 에 설정된 정보로 helm upgrade를 수행한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>microk8s helm upgrade --install airflow apache-airflow/airflow -f values.yaml
</pre></table></code></div></div><h2 id="dag-연동-확인하기">Dag 연동 확인하기</h2><p>브라우저로 Airflow에 접속을 해보자 그러면 Dag에 추가된 dag 가 보일 것이다. 안보여도 실망하지 말아라 이 부분은 한번에 잘 되지 않았다. 각종 정보들이 잘 연동되어야 하기 때문에 Production guide를 꼭 참조해볼 필요가 있다.</p><p>추가로 실제로 파일이 있는지 확인을 하는 방법이다. pod에 직접 접근을 해서 디렉토리에 파일이 있는지 확인 할 수 있다. command: kubectl exec -it<pod-name> -n <namespace> -- /bin/bash</namespace></pod-name></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>microk8s kubectl exec -it airflow-worker-0 -n airflow -- /bin/bash
</pre></table></code></div></div><p>접속이 되면 /opt/airflow 에 있게 된다. 이것이 $AIRFLOW_HOME의 위치이다. dags 디렉토리를 들어가보면 repo와 Hashkey의 디렉토리가 보인다. repo는 hashkey로 된 디렉토리를 가르치고 있다. repo를 들어가보면 git repository가 통째로 연결되어 있는 것을 확인할 수 있다.</p><blockquote><p>만약 Git이 push되서 정보가 변경되면 바로 Hashkey가 바뀌어 있는 것을 확인 할 수 있다.</p></blockquote><h2 id="private-git-설정-ssh">Private git 설정 (SSH)</h2><p>실제로 운영환경에서 사용하기 위해서는 Public git 보다는 Private git을 사용해야 한다. 여기서는 Git의 Private 환경에서 연결이 가능하도록 설정을 해보겠다.</p><h3 id="rsa-key생성-및-github-deploy-key-등록하기">RSA Key생성 및 Github Deploy key 등록하기</h3><p>Github의 Repository에 Public Key를 Deploy Key에 등록을 하고 Airflow에 Private key를 등록을 해야한다. 먼저 ssh키를 생성해보자. Repository에 권한이 있는 사용자의 이메일로 RSA를 만들어보자. 마지막에 -f 를 두어 파일 위치를 지정하자. 안그러면 ~/.ssh에 등록이 되어 다른 키와 중복이 될 수 있다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ssh-keygen -t rsa -b 4096 -C "your_email@example.com" -f ./id_rsa
</pre></table></code></div></div><p>모두 Default로 enter를 눌러서 넘어가자. 완료가 되면 아래와 같이 2개의 파일이 보일것이다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>$ ls -al 
...
-rw------- 1 healthon healthon 3381 11월 21 09:02 id_rsa
-rw-r--r-- 1 healthon healthon  744 11월 21 09:02 id_rsa.pub
...
</pre></table></code></div></div><ul><li>id_rsa : Private Key 이다. Airflow에 base64 로 변환하여 등록을 해야 한다.<li>id_rsa.pub : Public Key 이다. Github에 등록을 해야 한다.</ul><p>Github의 해당 Repository의 Settings에서 Security 세션에 Deploy keys를 선택한다. Add Deploy 버튼을 선택하면 입력창이 나오는데, 여기에 id_rsa.pub의 내용을 복사해서 넣는다. 제목은 관리하기 편한 이름으로 설정한다.</p><h3 id="airflow-설정-추가하기-1">Airflow 설정 추가하기</h3><p>이제 Airflow에 등록할 키를 변환해보자. 아래의 명령문으로 base64 변환을 하자. Key.txt에 private key가 변환되어 저장이 된다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>base64 ./id_rsa -w 0 &gt; key.txt
</pre></table></code></div></div><p>위에서 변환한 key를 가지고 value.yaml에 정보를 변경하자. Repo의 정보도 SSH로 접속하는 정보로 변경을 하자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>...
dags:
  gitSync:
    enabled: true
    repo: git@github.com:&lt;username&gt;/&lt;private-repo-name&gt;.git
    branch: &lt;branch-name&gt;
    subPath: &lt;dag-path&gt;
    sshKeySecret: airflow-ssh-secret
extraSecrets:
  airflow-ssh-secret:
    data: |
      gitSshKey: '&lt;base64-converted-ssh-private-key&gt;'
</pre></table></code></div></div><ul><li>repo : SSH 접근 경로를 입력하자. public은 https 로 가능한데, Private은 ssh 로 접근하는 경로를 입력해야 한다.<li>branch : 해당 branch를 입력한다.<li>subpath : repository에 dag 파일들이 있는 위치를 입력한다. (예: airflow/dags)<li>sshKeySecret: Secret 정보의 이름이다. (아래 extraSecrets에 등록된 이름이다.)<li>extraSecrets: k8s의 Secret에 저장을 한다.<li>GitSshKey : base64로 변환된 문자열을 ‘’ 안에 넣어준다. 이 정보는 k8s의 secret에서 확인할 수 있다.</ul><h3 id="github-knownhost-등록">Github knownhost 등록</h3><p>한가지가 더 남아있다. SSH 접속을 위해서는 Knowhost를 등록해야 한다. 이는 Production Guide에 나와있다. (Production Guide - Knownhost)[https://airflow.apache.org/docs/helm-chart/stable/production-guide.html#knownhosts]</p><p>Github의 Public key를 수집한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ssh-keyscan -t rsa github.com &gt; github_public_key
</pre></table></code></div></div><p>Public key를 가지고 Fingerprint를 출력하고 이정보를 (Github 공식 홈페이지)[https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/githubs-ssh-key-fingerprints]에서 확인을 한다. 우리는 rsa 방식을 선택했으니 (RSA)로 되어 있는 부분이 동일한지 확인한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ssh-keygen -lf github_public_key
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/posts/assets/platform/airflow_microk8s/github_ssh_fingerprints.png" alt="Github의 ssh key fingerprint 정보" width="400" />]</p><p>(RSA)의 SHA-256의 값이 동일하면 이제 설정에 추가하면 된다. value.yaml에 추가를 해보자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>...
dags:
  gitSync:
    knownHosts: |
      github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=
...      
</pre></table></code></div></div><p>value.yaml을 저장하고 Helm 을 upgrade 하자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>microk8s helm upgrade airflow apache-airflow/airflow -f value.yaml
</pre></table></code></div></div><h1 id="trouble-shooting">Trouble shooting</h1><p>설정을 변경하거나 추가하였을 경우 helm upgrade를 이용하는데 migration job이 구동이 된다. 그러면서 worker, scheduler, triggerer를 한 개 더 구동을 하고 정상 로딩되면 기존 pod는 삭제하는 방식을 사용하고 있다. 여기서 2가지 문제가 발생할 수 있다.</p><p>1) Mirtagion Job에서 문제가 발생 Config가 잘못되었을 경우 이런 경우가 발생한다. 설정을 다시 넣고 돌리면 되는 경우가 있다. 문제가 발생한 Job/pod는 kubectl delete 로 지운다.</p><p>2) Worker, Scheduler, Trigger 에서 오류가 발생하는 경우 기본 설정은 문제가 없는데, 실제 구동할 때 오류가 발생한다. git에 접속을 한다던가 할 때이다.</p><h1 id="conclusions">Conclusions</h1><p>설치는 의외로 간단하였으나 Dag를 구성하고 필요한 설정을 하는 부분은 시간이 걸렸다. Git의 연결 시 SSH, HTTPS와의 차이에 의해 설정 값이 달라지는 부분과 key를 넣을 때의 Space 문제로 시간이 좀 더 소요되었다. Airflow가 다양한 환경에서 Workflow를 구성할 수 있도록 하였지만, 결국에는 Python으로 Workflow를 구현을 해야 하기 때문에 설치/설정이 실제 개발의 시작이 된다고 볼 수 있다.</p><h1 id="references">References</h1><p>(Helm Chart for Apache Airflow)[https://airflow.apache.org/docs/helm-chart/stable/index.html]</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/platform/'>Platform</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Install Apache Airflow on Microk8s - Ahnchan&url=https://ahnchan.github.io/posts/Install-Airflow_on_Microk8s/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Install Apache Airflow on Microk8s - Ahnchan&u=https://ahnchan.github.io/posts/Install-Airflow_on_Microk8s/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Install Apache Airflow on Microk8s - Ahnchan&url=https://ahnchan.github.io/posts/Install-Airflow_on_Microk8s/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Platform-kafka-quick-start/">Apache Kafka - Quick Start</a><li><a href="/posts/Install-Jupyterhub_on_Microk8s/">Install JupyterHub on Microk8s</a><li><a href="/posts/Install-Airflow_on_Microk8s/">Install Apache Airflow on Microk8s</a><li><a href="/posts/gRPC-basic-java-step1/">gRPC - Java 환경구성하기, Dummy Service 만들기</a><li><a href="/posts/gRPC-basic-java-step2/">gRPC - Greeting Service 만들기</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav><div style="margin-top:20px;"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2304979176656635" data-ad-slot="4120180236" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-2304979176656635" data-ad-slot="1066641487"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Platform-kafka-quick-start/"><div class="card-body"> <span class="timeago small" > Jan 17, 2022 <i class="unloaded">2022-01-17T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Apache Kafka - Quick Start</h3><div class="text-muted small"><p> created : 2022-01-17, updated : 2022-01-17 Introduction Kafka는 기존의 Message Broker 의 기능을 업그레이드하여 BigData의 분석, Pipeline 등 대용량 분산환경에서 사용할 수 있는 Opne Source 이다. 대용량, 안정성(Partitioning, Relipcation) 을 보장...</p></div></div></a></div><div class="card"> <a href="/posts/Platform_virtualbox_ubuntu/"><div class="card-body"> <span class="timeago small" > Jul 1, 2021 <i class="unloaded">2021-07-01T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ubuntu 20.04를 VirtualBox에 설치하기</h3><div class="text-muted small"><p> Introduction 오픈 소스 프로젝트(특히 Cloud Native)를 구동하기 위해서는 Linux 환경이 필요한 경우가 많다. MacOS에 직접 설치를 해도 되지만, 테스트하고 지우기를 반복해야하기에 환경을 별도로 구성하는 것이 좋다. 이 튜토리얼에서는 Windows 10, MacOS에서 Ubuntu를 VirtualBox에 설치하고 간단하게 Im...</p></div></div></a></div><div class="card"> <a href="/posts/Platform_docker_swarm_ubuntu20/"><div class="card-body"> <span class="timeago small" > Jul 4, 2021 <i class="unloaded">2021-07-04T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker Swarm 구성하기(Ubuntu 20.04, Ansible)</h3><div class="text-muted small"><p> Introduction Docker Swarm 을 구성해서 docker를 여러 worker node에서 서비스할수 있는 구조를 구성해본다. 검색을 해보면 많은 구성 방법이 있으나 이 문서는 Docker 공식 Doc의 방식을 Ansible 로 구성해 봤다. 이 문서는 VirtualBox를 이용하여 Local에 Docker Swarm을 구성해봅니다. ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Install-Jupyterhub_on_Microk8s/" class="btn btn-outline-primary" prompt="Older"><p>Install JupyterHub on Microk8s</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/claude_ahn">Chanyoung Ahn</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ahnchan.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
