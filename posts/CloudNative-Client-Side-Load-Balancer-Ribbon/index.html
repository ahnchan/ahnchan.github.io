<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Client Side Load Balancer - Ribbon (Spring Cloud)" /><meta property="og:locale" content="en_US" /><meta name="description" content="created : 2021-09-17, updated : 2021-09-17" /><meta property="og:description" content="created : 2021-09-17, updated : 2021-09-17" /><link rel="canonical" href="https://ahnchan.github.io/posts/CloudNative-Client-Side-Load-Balancer-Ribbon/" /><meta property="og:url" content="https://ahnchan.github.io/posts/CloudNative-Client-Side-Load-Balancer-Ribbon/" /><meta property="og:site_name" content="Ahnchan" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-17T16:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Client Side Load Balancer - Ribbon (Spring Cloud)" /><meta name="twitter:site" content="@claude_ahn" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-09-17T16:00:00+09:00","datePublished":"2021-09-17T16:00:00+09:00","description":"created : 2021-09-17, updated : 2021-09-17","headline":"Client Side Load Balancer - Ribbon (Spring Cloud)","mainEntityOfPage":{"@type":"WebPage","@id":"https://ahnchan.github.io/posts/CloudNative-Client-Side-Load-Balancer-Ribbon/"},"url":"https://ahnchan.github.io/posts/CloudNative-Client-Side-Load-Balancer-Ribbon/"}</script><title>Client Side Load Balancer - Ribbon (Spring Cloud) | Ahnchan</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ahnchan"><meta name="application-name" content="Ahnchan"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-JLF9MP8SLS"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JLF9MP8SLS'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div class="site-title mt-3"> <a href="/">Ahnchan</a></div><div class="site-subtitle font-italic">The Infinity To Beyond!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ahnchan" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/claude_ahn" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ahnchan','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Client Side Load Balancer - Ribbon (Spring Cloud)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Client Side Load Balancer - Ribbon (Spring Cloud)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Chanyoung Ahn </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Sep 17, 2021, 4:00 PM +0900" prep="on" > Sep 17, 2021 <i class="unloaded">2021-09-17T16:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2445 words">13 min</span></div></div><div class="post-content"><p>created : 2021-09-17, updated : 2021-09-17</p><h1 id="introduction">Introduction</h1><p>이전 <a href="https://ahnchan.github.io/posts/CloudNative-Service-Registration-and-Discovery/">튜토리얼</a>에서 Service를 등록하고 간단하게 호출하는 부분을 진행했다. 이제는 Microservice 환경에서 각각의 서비스간 호출을 위해 사용하는 Load Balancing을 알아보겠다.</p><h1 id="requirements">Requirements</h1><p><a href="https://ahnchan.github.io/posts/CloudNative-Service-Registration-and-Discovery/">Service Registration and Discovery 튜토리얼</a>을 먼저 학습한다.</p><blockquote><p>Note. 이 튜토리얼의 소스는 <a href="https://github.com/ahnchan/tutorial-client-side-load-balancer-ribbon">이곳</a>에서 확인할 수 있다. initial은 이전 튜토리얼에서의 구성한 소스이고 complate는 본 튜토리얼에 추가한 부분이 포함되어 있다.</p></blockquote><h1 id="구성">구성</h1><p>Review 서비스를 2개 구동을 하고 details에서 review 정보를 가져올때 기존의 OpenFeign 을 이용한 것과 RestTemplate을 이용해서 가져오는 것을 설명할 거다. Review 서비스를 한 서버/랩탑에서 동시에 2개를 구동하기 위해서는 포트를 다르게 구동합니다. java -jar 명령에 Parameter를 추가하여 구동을 한다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/posts/assets/cloudnative/images/ribbon-diagram.png" alt="Diagram" width="500" /></p><h1 id="openfeign-으로-load-balancer-확인하기">OpenFeign 으로 Load Balancer 확인하기</h1><p>이전 튜토리얼에서는 OpenFeign 을 사용하였는데 이 기술을 사용하면 Ribbon(Load Balancer)을 자동으로 사용하고 있다. 그래서 구성도 처럼 reviews를 2개 구동하여 Client Side의 Load Balancer가 동작하는 것을 확인해보겠다. 이번에는 server port도 동적으로 변경하기 위해 모두 (discovery, details, reviews)을 jar로 패키징을 하고 jar로 실행을 하겠다.</p><h2 id="패키지를-만들기---discovery-details-reviews-모두-동일함">패키지를 만들기 - (discovery, details, reviews 모두 동일함)</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ mvn clean package
…
</pre></table></code></div></div><p>명령문을 수행하면 jar 파일을 만든것을 아래의 명령문으로 확인할 수 있다. (discovery를 예로 설명)</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>$ ls -al target
total 92488
drwxr-xr-x  11 ahnchan  staff       352 Sep 15 13:42 .
drwxr-xr-x@ 14 ahnchan  staff       448 Sep 13 12:05 ..
drwxr-xr-x   4 ahnchan  staff       128 Sep 13 12:05 classes
-rw-r--r--   1 ahnchan  staff  47347368 Sep  8 10:18 discovery-0.0.1-SNAPSHOT.jar
-rw-r--r--   1 ahnchan  staff      3163 Sep  8 10:18 discovery-0.0.1-SNAPSHOT.jar.original
drwxr-xr-x   3 ahnchan  staff        96 Sep  8 10:18 generated-sources
drwxr-xr-x   3 ahnchan  staff        96 Sep  8 10:18 generated-test-sources
drwxr-xr-x   3 ahnchan  staff        96 Sep  8 10:18 maven-archiver
drwxr-xr-x   3 ahnchan  staff        96 Sep  8 10:18 maven-status
drwxr-xr-x   4 ahnchan  staff       128 Sep  8 10:18 surefire-reports
drwxr-xr-x   3 ahnchan  staff        96 Sep 13 12:05 test-classes
</pre></table></code></div></div><p>discovery-0.0.1-SNAPSHOT.jar가 패키징 된것을 확인할 수 있다. 이제 각각의 서비스에서 java -jar 명령문을 이용해서 구동을 하겠다.</p><h2 id="discovery-실행하기">Discovery 실행하기</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>$ java -jar target/discovery-0.0.1-SNAPSHOT.jar

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.5.4)

2021-09-15 15:28:06.279  INFO 22448 --- [           main] c.a.b.discovery.DiscoveryApplication     : Starting DiscoveryApplication v0.0.1-SNAPSHOT using Java 11.0.11 on 36-221-190-190.cab.prima.net.ar with PID 22448 (/Users/ahnchan/Workspaces/Projects/Tutorial/tutorial-spring-service-registration-and-discovery/bookstore/complete/discovery/target/discovery-0.0.1-SNAPSHOT.jar started by ahnchan in /Users/ahnchan/Workspaces/Projects/Tutorial/tutorial-spring-service-registration-and-discovery/bookstore/complete/discovery)
2021-09-15 15:28:06.283  INFO 22448 --- [           main] c.a.b.discovery.DiscoveryApplication     : No active profile set, falling back to default profiles: default
2021-09-15 15:28:07.888  INFO 22448 --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=b429867f-893f-3880-a8fd-fde460bda783
2021-09-15 15:28:08.320  INFO 22448 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8761 (htt
…
</pre></table></code></div></div><h2 id="details-실행하기">Details 실행하기</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>$ java -jar target/details-0.0.1-SNAPSHOT.jar

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.5.4)

2021-09-15 15:29:54.281  INFO 22560 --- [           main] c.a.b.details.DetailsApplication         : Starting DetailsApplication v0.0.1-SNAPSHOT using Java 11.0.11 on 36-221-190-190.cab.prima.net.ar with PID 22560 (/Users/ahnchan/Workspaces/Projects/Tutorial/tutorial-spring-service-registration-and-discovery/bookstore/complete/details/target/details-0.0.1-SNAPSHOT.jar started by ahnchan in /Users/ahnchan/Workspaces/Projects/Tutorial/tutorial-spring-service-registration-and-discovery/bookstore/complete/details)
2021-09-15 15:29:54.285  INFO 22560 --- [           main] c.a.b.details.DetailsApplication         : No active profile set, falling back to default profiles: default
2021-09-15 15:29:55.526  INFO 22560 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2021-09-15 15:29:55.809  INFO 22560 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Finished Spring Data repository scanning in 267 ms. Found 1 JPA repository interfaces.
2021-09-15 15:29:56.157  INFO 22560 --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=fd885a71-07b6-3efc-a47c-dca5b79e1c85
2021-09-15 15:29:56.734  INFO 22560 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
…
</pre></table></code></div></div><h2 id="reviews에-디버깅-코드-추가-및-2개의-application-을-실행하기">Reviews에 디버깅 코드 추가 및 2개의 Application 을 실행하기</h2><p>2개의 Application을 구동할 것이기에 구분을 하기 위해서 화면에 정보를 뿌려주는 코드를 추가해보겠다. 화면에 요청된 Product의 Id 출력해주는 부분을 추가하였다.</p><p>파일 : ReviewsApplication.java</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>…
   @GetMapping("/products/{id}/reviews")
   public List&lt;Review&gt; getReviewsByProductId(@PathVariable Integer id) {
      
       System.out.println("Product Id : "+ id);
 
       return repository.retrivefindById_product(id);
   }
…
</pre></table></code></div></div><p>변경된 내용을 적용하기 위해 패키지하고 실행을 한다. 첫번째 Application을 실행한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ mvn clean package
…
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>$ java -jar target/reviews-0.0.1-SNAPSHOT.jar

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.5.4)

2021-09-15 15:31:05.975  INFO 22579 --- [           main] c.a.b.reviews.ReviewsApplication         : Starting ReviewsApplication v0.0.1-SNAPSHOT using Java 11.0.11 on 36-221-190-190.cab.prima.net.ar with PID 22579 (/Users/ahnchan/Workspaces/Projects/Tutorial/tutorial-spring-service-registration-and-discovery/bookstore/complete/reviews/target/reviews-0.0.1-SNAPSHOT.jar started by ahnchan in /Users/ahnchan/Workspaces/Projects/Tutorial/tutorial-spring-service-registration-and-discovery/bookstore/complete/reviews)
2021-09-15 15:31:05.977  INFO 22579 --- [           main] c.a.b.reviews.ReviewsApplication         : No active profile set, falling back to default profiles: default
2021-09-15 15:31:07.226  INFO 22579 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2021-09-15 15:31:07.509  INFO 22579 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Finished Spring Data repository scanning in 267 ms. Found 1 JPA repository interfaces.
2021-09-15 15:31:07.865  INFO 22579 --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=f2b73979-807b-3a06-b09f-29a426ba36b7
2021-09-15 15:31:08.418  INFO 22579 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8081 (http)
…
</pre></table></code></div></div><p>Properties 파일에 선언된 8081로 Application 을 시작하였다. 두번째 Application은 포트를 8082로 바꾸어서 시작을 해보겠다.</p><blockquote><p>Note. Parameter를 넣지 않으면 8081포트를 기존에 사용하고 있다는 오류 메세지가 나온다. 포트는 하나의 프로세스가 사용하면 다른 프로세스에서는 사용할 수가 없으니 이런 오류가 발생한다.</p></blockquote><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>$ java -jar target/reviews-0.0.1-SNAPSHOT.jar --server.port=8082

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.5.4)

2021-09-15 15:37:00.312  INFO 22670 --- [           main] c.a.b.reviews.ReviewsApplication         : Starting ReviewsApplication v0.0.1-SNAPSHOT using Java 11.0.11 on 36-221-190-190.cab.prima.net.ar with PID 22670 (/Users/ahnchan/Workspaces/Projects/Tutorial/tutorial-spring-service-registration-and-discovery/bookstore/complete/reviews/target/reviews-0.0.1-SNAPSHOT.jar started by ahnchan in /Users/ahnchan/Workspaces/Projects/Tutorial/tutorial-spring-service-registration-and-discovery/bookstore/complete/reviews)
2021-09-15 15:37:00.315  INFO 22670 --- [           main] c.a.b.reviews.ReviewsApplication         : No active profile set, falling back to default profiles: default
2021-09-15 15:37:01.392  INFO 22670 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Bootstrapping Spring Data JPA repositories in DEFAULT mode.
2021-09-15 15:37:01.688  INFO 22670 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Finished Spring Data repository scanning in 282 ms. Found 1 JPA repository interfaces.
2021-09-15 15:37:02.031  INFO 22670 --- [           main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=f2b73979-807b-3a06-b09f-29a426ba36b7
2021-09-15 15:37:02.590  INFO 22670 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8082 (http)
…
</pre></table></code></div></div><p>8082포트로 구동된 것을 확인할 수 있을 것이다. Eureka Server(Discovery 서버의 8761 포트)에 브라우저로 접속하여 Reviews가 2개 접속되어 있는 것을 확인할 수 있다. (https://localhost:8761)</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/posts/assets/cloudnative/images/ribbon-eureka-server.png" alt="Eureka Server Web" width="500" /></p><p>이제 detail에 API를 호출해서 review의 서비스 요청을 2개의 Application에서 번갈아가면서 처리하는 것을 확인해보자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>$ curl localhost:8080/products/1/detailsV2 | jq

{
  "product": {
    "id": 1,
    "title": "The Keeper of Happy Endings",
    "author": "Barbara Davis",
    "isbn": "1542021472"
  },
  "reviews": [
    {
      "id": 1,
      "id_product": 1,
      "reviewer": "linda galella",
      "text": "we just don't like each other very much.\\”"
    },
    {
      "id": 2,
      "id_product": 1,
      "reviewer": "Klapaucjusz",
      "text": "It is one more book about WW II where action takes place in different time frames."
    },
    {
      "id": 5,
      "id_product": 1,
      "reviewer": "DisneyDenizen",
      "text": "ON THE PLUS SIDE: Written by an established author."
    }
  ]
}
</pre></table></code></div></div><p>Detail Service에 Id는 1인 Product의 모든 정보를 요청하였다. 결과는 위와 같이 리뷰정보까지 가져온다. 이렇게 4번 정도 수행하면 아래와 같이 2개의 Application 에서 찍히는 것을 확인할 수 있다. 위는 8081로 구동한 Reviews Application이고 아래는 8082로 구동한 Reviews Application이다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/posts/assets/cloudnative/images/ribbon-review-terminals-02.png" alt="Reviews Applcation Outputs #2" width="500" /></p><h1 id="resttemplate을-이용여-loadbalance-처리하기-ribbon">RestTemplate을 이용여 LoadBalance 처리하기 (Ribbon)</h1><p>RestTemplate을 이용하여 Service를 호출해 보겠다. 먼저 Ribbon을 Dependencies에 추가를 해야한다. 현재 튜토리얼에서는 OpenFeign 을 사용하면 Ribbon이 포함되기 때문에 따로 추가를 하지 않아도 되지만, OpenFeign을 사용하지 않으면 라이브러리를 추가해야한다.</p><p>RestTemplate을 설정을 해보자. Configuration을 RestTemplate을 설정하고, @LoadBalanced를 추가한다. 이 Annotation 으로 간단하게 Client 에서의 Load Balance를 구성할 수 있다.</p><p>파일: DetailsApplication.java</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>@Configuration
class MyConfiguration {

  @LoadBalanced
  @Bean
  RestTemplate restTemplate() {
     return new RestTemplate();
  }
}
</pre></table></code></div></div><p>Details에 서비스를 API를 추가해보자.</p><p>파일 : DetailsApplication.java</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>@GetMapping("/products/{id}/detailsV1")
public ProductDetail getProductDetails(@PathVariable Integer id) {

  Optional&lt;Product&gt; product = repository.findById(id);
  ProductDetail details = new ProductDetail();
  details.setProduct(repository.findById(id).get());
  details.setReviews(restTemplate.getForObject("http://reviews/products/"+id+"/reviews", List.class));

  return details;
}
</pre></table></code></div></div><p>Details Application을 실행해보자. 기존에 동작하고 있으면 먼저 종료를 한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ mvn spring-boot:run
…
</pre></table></code></div></div><p>이제 실행해서 API를 호출해보자. detailsV1을 호출한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre>$ curl localhost:8080/products/1/detailsV1 | jq

{
  "product": {
    "id": 1,
    "title": "The Keeper of Happy Endings",
    "author": "Barbara Davis",
    "isbn": "1542021472"
  },
  "reviews": [
    {
      "id": 1,
      "id_product": 1,
      "reviewer": "linda galella",
      "text": "we just don't like each other very much.\\”"
    },
    {
      "id": 2,
      "id_product": 1,
      "reviewer": "Klapaucjusz",
      "text": "It is one more book about WW II where action takes place in different time frames."
    },
    {
      "id": 5,
      "id_product": 1,
      "reviewer": "DisneyDenizen",
      "text": "ON THE PLUS SIDE: Written by an established author."
    }
  ]
}
</pre></table></code></div></div><p>4번을 수행해보면 각각의 Reviews Service에 디버깅 코드가 번갈아가면서 나오는 것을 확인 할 수 있다.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/posts/assets/cloudnative/images/ribbon-review-terminals-02.png" alt="Reviews Applcation Outputs #2" width="500" /></p><h1 id="conclusions">Conclusions</h1><p>Ribbon을 사용하여 Client 에서의 Load Balancer를 추가하는 방법을 확인해보았다. Client Side Load Balancer는 Microservice에서 서비스간의 통신을 간단하게 할수 있는 방법을 제시하고 있다.</p><h1 id="references">References</h1><p>(Client Side Load Balancer: Ribbon)[https://cloud.spring.io/spring-cloud-static/Dalston.SR5/multi/multi_spring-cloud-ribbon.html]</p><p>(Spring RestTemplate as a Load Balancer Client)[https://cloud.spring.io/spring-cloud-static/Dalston.SR5/multi/multi__spring_cloud_commons_common_abstractions.html#_spring_resttemplate_as_a_load_balancer_client]</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cloudnative/'>CloudNative</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Client Side Load Balancer - Ribbon (Spring Cloud) - Ahnchan&url=https://ahnchan.github.io/posts/CloudNative-Client-Side-Load-Balancer-Ribbon/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Client Side Load Balancer - Ribbon (Spring Cloud) - Ahnchan&u=https://ahnchan.github.io/posts/CloudNative-Client-Side-Load-Balancer-Ribbon/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Client Side Load Balancer - Ribbon (Spring Cloud) - Ahnchan&url=https://ahnchan.github.io/posts/CloudNative-Client-Side-Load-Balancer-Ribbon/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Platform-kafka-quick-start/">Apache Kafka - Quick Start</a><li><a href="/posts/Install-Jupyterhub_on_Microk8s/">Install JupyterHub on Microk8s</a><li><a href="/posts/Install-Airflow_on_Microk8s/">Install Apache Airflow on Microk8s</a><li><a href="/posts/gRPC-basic-java-step1/">gRPC - Java 환경구성하기, Dummy Service 만들기</a><li><a href="/posts/gRPC-basic-java-step2/">gRPC - Greeting Service 만들기</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav><div style="margin-top:20px;"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-2304979176656635" data-ad-slot="4120180236" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2304979176656635" crossorigin="anonymous"></script> <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-2304979176656635" data-ad-slot="1066641487"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/CloudNative-Dapr-Hello-Kubernetes/"><div class="card-body"> <span class="timeago small" > Nov 7, 2021 <i class="unloaded">2021-11-07T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Dapr Hello Kubernetes</h3><div class="text-muted small"><p> created : 2021-11-07, updated : 2021-11-07 Introduction 이번 튜토리얼에서는 Dapr를 Kubernetes에 올려보겠다. dapr의 특징인 Service Invocation과 State Management 를 사용할 것이다. Note. 본 소스는 Dapr 공식 Quick Start의 Hello-Kub...</p></div></div></a></div><div class="card"> <a href="/posts/CloudNative-Service-Registration-and-Discovery/"><div class="card-body"> <span class="timeago small" > Sep 9, 2021 <i class="unloaded">2021-09-09T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Service Registration and Discovery (Spring Boot)</h3><div class="text-muted small"><p> created : 2021-09-09, updated : 2021-09-09 Introduction Spring Framework 환경에서 서비스를 등록/관리하고 이 서비스를 다른 서비스에서 사용하는 방법을 설명해보겠다. 이 문서는 https://spring.io/guides/gs/service-registration-and-discovery/를 기...</p></div></div></a></div><div class="card"> <a href="/posts/CloudNative-Circuit-Breaker/"><div class="card-body"> <span class="timeago small" > Oct 7, 2021 <i class="unloaded">2021-10-07T16:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spring Cloud Circuit Breaker</h3><div class="text-muted small"><p> created : 2021-10-07, updated : 2021-10-07 Introduction 서비스간 데이터를 요청할때 한쪽 서비스에 문제가 발생하였을 경우가 있다. 이럴 때를 대비하여 정보는 Default로 전달하여 전체 서비스가 오류가 나는 것을 방지 할 수 있다. 이때를 위해 Circuit Breaker를 이용하여 Default정보를 보...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CloudNative-Service-Registration-and-Discovery/" class="btn btn-outline-primary" prompt="Older"><p>Service Registration and Discovery (Spring Boot)</p></a> <a href="/posts/CloudNative-Circuit-Breaker/" class="btn btn-outline-primary" prompt="Newer"><p>Spring Cloud Circuit Breaker</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/claude_ahn">Chanyoung Ahn</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ahnchan.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
